@using System.Text;
@using YA.WebClient.Application
@using YA.WebClient.Application.Caches
@using Microsoft.AspNetCore.JsonPatch

@inject VkPeriodicParsingTaskModal EditTaskModal
@inject IMapper Mapper
@inject IThemeOptionsState ThemeOptions

@implements IDisposable

@inherits BaseParsingTaskModal

<Modal @ref="_modal" Closing="@OnModalClosing" ShowBackdrop="true">
    <ModalContent Centered="true" Size="ModalSize.Large" Class="@ThemeOptions.ModalContentClass">
        <ModalHeader>
            <ModalTitle>Периодическая задача парсинга</ModalTitle>
            <CloseButton Clicked="OnModalClose" AutoClose="true" />
        </ModalHeader>
        <ModalBody>
            <ModalApiIssueAlert @ref="_modalAlert" />
            @* валидация не вызывается при @bind *@
            <Validations Mode="ValidationMode.Manual" @ref="_editParsingTaskModalValidation" Model="@_editTaskModal">
                <Tabs SelectedTab="@_editTaskModal.SourceType.ToString()">
                    <Items>
                        <Tooltip Fade="true"
                                 Text="Ссылки на сообщества и ключевые слова"
                                 Placement="TooltipPlacement.Top"
                                 Multiline="true"
                                 AlwaysActive="false">
                            <Tab Name="@VkParsingTaskSourceType.Links.ToString()" Class="boldtext" Disabled="true">
                                <Icon Name="IconName.Edit" />
                            </Tab>
                        </Tooltip>
                        <Tooltip Fade="true"
                                 Text="Выполненные задачи"
                                 Placement="TooltipPlacement.Top"
                                 Multiline="true"
                                 AlwaysActive="false">
                            <Tab Name="@VkParsingTaskSourceType.Tasks.ToString()" Class="boldtext" Disabled="true">
                                <Icon Name="IconName.List" />
                            </Tab>
                        </Tooltip>
                    </Items>
                    <Content>
                        <TabPanel Name="@VkParsingTaskSourceType.Links.ToString()" Class="mt-3">
                            <Validation Validator="@ValidateSourceIdsRawInput">
                                <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                                    <FieldLabel Class="boldtext">Введите идентификаторы, ссылки на сообщества (профили) ВКонтакте или ключевые слова</FieldLabel>
                                    <MemoEdit @bind-Text="@_editTaskModal.OptionsSmRawLinkSources" Rows="5" MaxLength="400000" Autofocus="true" Placeholder="Каждая ссылка с новой строки, не более 1000 ссылок за раз">
                                        <Feedback>
                                            <ValidationError Tooltip="false" />
                                        </Feedback>
                                    </MemoEdit>
                                </Field>
                            </Validation>
                        </TabPanel>
                        <TabPanel Name="@VkParsingTaskSourceType.Tasks.ToString()" Class="mt-3">
                            <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                                <FieldLabel Class="boldtext">Выполненные задачи</FieldLabel>
                                <BlazoredTypeahead style="padding-left:.75rem"
                                                   SearchMethod="GetParsingTasksAsTaskSource"
                                                   TValue="string"
                                                   TItem="VkQuickParsingTaskVm"
                                                   Value="@_selectedSearchValue"
                                                   ValueChanged="@((v) => OnTaskSearchValueChanged(v))"
                                                   ValueExpression="@(() => _selectedSearchValue)"
                                                   ConvertMethod="ConvertParsingTask"
                                                   ShowDropDownOnFocus="true"
                                                   EnableDropDown="true"
                                                   MinimumLength="1"
                                                   MaximumSuggestions="10"
                                                   Debounce="500"
                                                   Disabled="true">
                                    <SelectedTemplate Context="task">
                                        <div style="color:#212529">
                                            @task
                                        </div>
                                    </SelectedTemplate>
                                    <ResultTemplate Context="task">
                                        <div>
                                            @task.Title
                                        </div>
                                        <div>
                                            Объектов: @task.VkResultsCount
                                        </div>
                                    </ResultTemplate>
                                    <NotFoundTemplate>
                                        <Text Class="text-muted">
                                            Ничего не найдено
                                        </Text>
                                    </NotFoundTemplate>
                                </BlazoredTypeahead>
                            </Field>
                            @if (_tasksSourcesIsLoading)
                            {
                                <Field ColumnSize="ColumnSize.Is12" Class="no-gutters" Style="padding-top:7px">
                                    <Wave Color="black" Size="14px" />
                                </Field>
                            }
                            else
                            {
                                <Field ColumnSize="ColumnSize.Is12">
                                    @foreach (VkQuickParsingTaskVm item in _selectedTasks)
                                    {
                                        <Badge Color="Color.Primary" Style="font-size:100%">
                                            @item.Title
                                        </Badge>
                                    }
                                </Field>
                            }
                        </TabPanel>
                    </Content>
                </Tabs>
                <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                    <div style="width: 100%; line-height:24px">
                        <div style="display: inline-block">
                            <FieldLabel Class="boldtext">Название задачи</FieldLabel>
                        </div>
                        <div style="display: inline-block; float:right">
                            <Switch Size="Size.Small" TValue="bool" @bind-Checked="@_editTaskModal.AutoNamingIsOn">
                                <Text Style="font-size:12px">Автоименование</Text>
                            </Switch>
                        </div>
                    </div>
                    <TextEdit @bind-Text="@_editTaskModal.OptionsSmTitleRawInput" Placeholder="Введите название..." />
                </Field>
                @if (_editTaskModal.ResultTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is5" Class="no-gutters">
                        <FieldLabel Class="boldtext">Что нужно получить?</FieldLabel>
                        <FieldBody>
                            <RadioGroup Size="Size.None"
                                        TValue="VkParsingTaskResultType"
                                        @bind-CheckedValue="@_editTaskModal.ResultType"
                                        Buttons="true">
                                <Radio Disabled="true" TValue="VkParsingTaskResultType" Value="@VkParsingTaskResultType.Profiles">Пользователи</Radio>
                                <Radio Disabled="true" TValue="VkParsingTaskResultType" Value="@VkParsingTaskResultType.Communities">Сообщества</Radio>
                            </RadioGroup>
                        </FieldBody>
                        <Field Class="no-gutters" Style="display:inline-block">
                            <Tooltip Fade="true"
                                     @bind-Text="@_editTaskModal.WhatToGetTooltipText"
                                     Placement="TooltipPlacement.Right"
                                     Multiline="true"
                                     AlwaysActive="false">
                                <Icon Name="IconName.QuestionCircle" Style="color:#969392" />
                            </Tooltip>
                        </Field>
                    </Field>
                }
                @if (_editTaskModal.ProfilesResultSubTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                        <FieldLabel Class="boldtext">Каких пользователей нужно получить?</FieldLabel>
                        <FieldBody>
                            <RadioGroup Size="Size.None"
                                        TValue="VkParsingTaskResultProfilesSubType"
                                        CheckedValue="@_editTaskModal.ProfilesResultSubType"
                                        CheckedValueChanged="@((value) => OnProfilesResultSubTypeChanged(value))"
                                        Buttons="true"
                                        Style="white-space:nowrap">
                                <Radio Disabled="true" Value="@VkParsingTaskResultProfilesSubType.All">Всех</Radio>
                                <Radio Disabled="true" Value="@VkParsingTaskResultProfilesSubType.Active">Активных</Radio>
                                <Radio Disabled="true" Value="@VkParsingTaskResultProfilesSubType.Top">Топ</Radio>
                                <Radio Disabled="true" Value="@VkParsingTaskResultProfilesSubType.GroupIntersection">Пересечения</Radio>
                                <Radio Disabled="true" Value="@VkParsingTaskResultProfilesSubType.Friends">Друзья</Radio>
                                <Radio Disabled="true" Value="@VkParsingTaskResultProfilesSubType.DetailedProfiles">Экспорт в CSV</Radio>
                            </RadioGroup>
                        </FieldBody>
                        <Field Class="no-gutters" Style="display:inline-block">
                            <Tooltip Fade="true"
                                     @bind-Text="@_editTaskModal.WhatUsersToGetTooltipText"
                                     Placement="TooltipPlacement.Right"
                                     Multiline="true">
                                <Icon Name="IconName.QuestionCircle" Style="color:#969392" />
                            </Tooltip>
                        </Field>
                    </Field>
                }
                @if (_editTaskModal.CommunitiesResultSubTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                        <FieldLabel Class="boldtext">Какие сообщества нужно получить?</FieldLabel>
                        <FieldBody>
                            <RadioGroup Size="Size.None"
                                        TValue="VkParsingTaskResultCommunitiesSubType"
                                        @bind-CheckedValue="@_editTaskModal.CommunitiesResultSubType"
                                        Buttons="true">
                                <Radio Disabled="true" Value="@VkParsingTaskResultCommunitiesSubType.TaIntersection">Сообщества с ЦА</Radio>
                                <Radio Disabled="true" Value="@VkParsingTaskResultCommunitiesSubType.CommunitiesSearch">Поиск сообществ</Radio>
                            </RadioGroup>
                        </FieldBody>
                        <Field Class="no-gutters" Style="display:inline-block">
                            <Tooltip Fade="true"
                                     @bind-Text="@_editTaskModal.WhatCommunitiesToGetTooltipText"
                                     Placement="TooltipPlacement.Right"
                                     Multiline="true">
                                <Icon Name="IconName.QuestionCircle" Style="color:#969392" />
                            </Tooltip>
                        </Field>
                    </Field>
                }

                @if (_editTaskModal.ProfilesResultActiveTypeVisible)
                {
                    <Field Horizontal="true" ColumnSize="ColumnSize.Is12" Class="no-gutters" Style="margin-bottom:0rem">
                        <Fields ColumnSize="ColumnSize.Is12">
                            <Field ColumnSize="ColumnSize.Is3" Class="d-inline-block align-top">
                                <FieldLabel Class="boldtext">Активных в</FieldLabel>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveSourcePosts">Посты</Check>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveSourceDiscussions">Обсуждения</Check>
                            </Field>
                            <Field ColumnSize="ColumnSize.Is4" Class="d-inline-block">
                                <FieldLabel Class="boldtext">Тип активности</FieldLabel>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveTypeLikes">Лайки</Check>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveTypeLikesInComments">Лайки в комментариях</Check>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveTypeComments">Комментарии</Check>
                                <Tooltip Fade="true" Text="Работает только если вы администратор сообщества" Placement="TooltipPlacement.Bottom" Multiline="true">
                                    <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveTypeReposts">Репосты</Check>
                                </Tooltip>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveTypePostAuthors">Авторы постов</Check>
                            </Field>
                            @if (_editTaskModal.ActivitySourceInvalid)
                            {
                                <Field Display="Display.Flex">
                                    <Text Style="font-size:12px" Color="TextColor.Danger">Необходимо выбрать хотя бы один источник активностей.</Text>
                                </Field>
                            }
                            @if (_editTaskModal.ActivityTypeInvalid)
                            {
                                <Field Display="Display.Flex">
                                    <Text Style="font-size:12px" Color="TextColor.Danger">Необходимо выбрать хотя бы один тип активностей.</Text>
                                </Field>
                            }
                        </Fields>
                    </Field>
                    <Field Horizontal="true" ColumnSize="ColumnSize.Is12" Class="no-gutters" Style="margin-bottom:0rem">
                        <FieldLabel ColumnSize="ColumnSize.Is3" Class="boldtext">Период активности</FieldLabel>
                        <FieldBody ColumnSize="ColumnSize.Is9">
                            <Fields>
                                <Validation Validator="@ValidateActivityPerodStart">
                                    <Field ColumnSize="ColumnSize.Is6">
                                        <Addons>
                                            <Addon AddonType="AddonType.Start">
                                                <AddonLabel>c</AddonLabel>
                                            </Addon>
                                            <Addon AddonType="AddonType.Body">
                                                @*https://github.com/stsrki/Blazorise/issues/1811*@
                                                @*https://github.com/stsrki/Blazorise/issues/1812*@
                                                <DateEdit TValue="DateTime?" Date="@_activePeriodStart" DateChanged="@OnActivePeriodStartChanged" />
                                            </Addon>
                                        </Addons>
                                    </Field>
                                </Validation>
                                <Validation Validator="@ValidateActivityPerodEnd">
                                    <Field ColumnSize="ColumnSize.Is6">
                                        <Addons>
                                            <Addon AddonType="AddonType.Start">
                                                <AddonLabel>по</AddonLabel>
                                            </Addon>
                                            <Addon AddonType="AddonType.Body">
                                                @*https://github.com/stsrki/Blazorise/issues/1811*@
                                                @*https://github.com/stsrki/Blazorise/issues/1812*@
                                                <DateEdit TValue="DateTime?" Date="@_activePeriodEnd" DateChanged="@OnActivePeriodEndChanged" />
                                            </Addon>
                                        </Addons>
                                    </Field>
                                </Validation>
                            </Fields>
                        </FieldBody>
                    </Field>
                    <Validation>
                        <Field Horizontal="true" ColumnSize="ColumnSize.Is12" Class="no-gutters">
                            <FieldLabel ColumnSize="ColumnSize.Is3" Class="boldtext">Число активностей</FieldLabel>
                            <FieldBody ColumnSize="ColumnSize.Is9">
                                <Addons>
                                    <Addon AddonType="AddonType.Start">
                                        <AddonLabel>от</AddonLabel>
                                    </Addon>
                                    <Addon AddonType="AddonType.Body">
                                        <NumericEdit Min="1" Max="@int.MaxValue" Step="1" TValue="int?" @bind-Value="@_editTaskModal.ProfilesResultActiveActivityCountFrom">
                                            <Feedback>
                                                <ValidationError Tooltip="false" />
                                            </Feedback>
                                        </NumericEdit>
                                    </Addon>
                                </Addons>
                            </FieldBody>
                        </Field>
                    </Validation>
                    <Field Horizontal="true" ColumnSize="ColumnSize.Is12" Class="no-gutters">
                        <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultActiveLimitWallPostsCount">Ограничить количество постов для сбора 1000 шт.</Check>
                    </Field>
                }

                @if (_editTaskModal.ProfilesResultTopTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                        <FieldLabel Class="boldtext">Анализировать пользовательские сообщества</FieldLabel>
                        <RadioGroup Orientation="Orientation.Horizontal"
                                    Size="Size.Small"
                                    TValue="VkParsingTaskResultProfileTopType"
                                    @bind-CheckedValue="@_editTaskModal.ProfilesResultTopType"
                                    Buttons="false">
                            <Radio Value="@VkParsingTaskResultProfileTopType.Top3">Топ-3</Radio>
                            <Radio Value="@VkParsingTaskResultProfileTopType.Top5">Топ-5</Radio>
                            <Radio Value="@VkParsingTaskResultProfileTopType.Top10">Топ-10</Radio>
                            <Radio Value="@VkParsingTaskResultProfileTopType.Top20">Топ-20</Radio>
                            <Radio Value="@VkParsingTaskResultProfileTopType.Top30">Топ-30</Radio>
                        </RadioGroup>
                    </Field>
                    <Validation>
                        <Field ColumnSize="ColumnSize.Is12" Horizontal="true" Class="no-gutters">
                            <FieldLabel ColumnSize="ColumnSize.Is7" Class="boldtext">Число сообществ, которые у пользователя в ТОП</FieldLabel>
                            <FieldBody ColumnSize="ColumnSize.Is5">
                                <NumericEdit Min="1" Max="@int.MaxValue" Step="1" TValue="int?" @bind-Value="@_editTaskModal.TopCommunitiesCount">
                                    <Feedback>
                                        <ValidationError Tooltip="false" />
                                    </Feedback>
                                </NumericEdit>
                            </FieldBody>
                        </Field>
                    </Validation>
                }
                @if (_editTaskModal.ProfilesResultGroupIntersectionTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                        @if (_editTaskModal.ValidatedForm.SourcesObjectType == VkParsingTaskSourcesObjectType.Group)
                        {
                            <FieldLabel Class="boldtext">Число общих сообществ у участников</FieldLabel>
                        }
                        else
                        {
                            <FieldLabel Class="boldtext">Число общих друзей у пользователей</FieldLabel>
                        }
                        <Fields>
                            <Validation>
                                <Field ColumnSize="ColumnSize.Is6">
                                    <Addons>
                                        <Addon AddonType="AddonType.Start">
                                            <AddonLabel>от</AddonLabel>
                                        </Addon>
                                        <Addon AddonType="AddonType.Body">
                                            <NumericEdit Min="1" Max="@int.MaxValue" Step="1" TValue="int?" @bind-Value="@_editTaskModal.ProfilesResultGiCountFrom">
                                                <Feedback>
                                                    <ValidationError Tooltip="false" />
                                                </Feedback>
                                            </NumericEdit>
                                        </Addon>
                                    </Addons>
                                </Field>
                            </Validation>
                            <Validation>
                                <Field ColumnSize="ColumnSize.Is6">
                                    <Addons>
                                        <Addon AddonType="AddonType.Start">
                                            <AddonLabel>до</AddonLabel>
                                        </Addon>
                                        <Addon AddonType="AddonType.Body">
                                            <NumericEdit Min="1" Max="@int.MaxValue" Step="1" TValue="int?" @bind-Value="@_editTaskModal.ProfilesResultGiCountTo">
                                                <Feedback>
                                                    <ValidationError Tooltip="false" />
                                                </Feedback>
                                            </NumericEdit>
                                        </Addon>
                                    </Addons>
                                </Field>
                            </Validation>
                        </Fields>
                    </Field>
                }

                @if (_editTaskModal.ProfilesResultFriendsTypeVisible)
                {
                    <Field Horizontal="true" ColumnSize="ColumnSize.Is12" Class="no-gutters" Style="margin-bottom:0rem">
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is5" Class="d-inline-block align-top" Style="max-width:100%; flex:0 0 100%">
                                <FieldLabel Class="boldtext">Тип друзей</FieldLabel>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultFriendsGetFriends">Друзья</Check>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultFriendsGetFollowers">Подписчики</Check>
                                <Check TValue="bool?" @bind-Checked="_editTaskModal.ProfilesResultFriendsGetPeopleSubscriptions">На кого подписан</Check>
                            </Field>
                            @if (_editTaskModal.FriendsTypeInvalid)
                            {
                                <Field Display="Display.Flex">
                                    <Text Style="font-size:12px" Color="TextColor.Danger">Необходимо выбрать хотя бы один тип друзей.</Text>
                                </Field>
                            }
                        </Fields>
                    </Field>
                }

                @if (_editTaskModal.CommunitiesResultTaIntersectionTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters">
                        <FieldLabel Class="boldtext">Анализировать пользовательские сообщества</FieldLabel>
                        <RadioGroup Orientation="Orientation.Horizontal"
                                    Size="Size.Small"
                                    TValue="VkParsingTaskResultCommunitiesTopType"
                                    @bind-CheckedValue="@_editTaskModal.CommunitiesResultTaIntersectionTopType"
                                    Buttons="false">
                            <Radio Value="@VkParsingTaskResultCommunitiesTopType.Top3">Топ-3</Radio>
                            <Radio Value="@VkParsingTaskResultCommunitiesTopType.Top5">Топ-5</Radio>
                            <Radio Value="@VkParsingTaskResultCommunitiesTopType.Top10">Топ-10</Radio>
                            <Radio Value="@VkParsingTaskResultCommunitiesTopType.Top15">Топ-15</Radio>
                            <Radio Value="@VkParsingTaskResultCommunitiesTopType.All">Все</Radio>
                        </RadioGroup>
                    </Field>
                    <Validation>
                        <Field ColumnSize="ColumnSize.Is12" Horizontal="true" Class="no-gutters">
                            <FieldLabel ColumnSize="ColumnSize.Is7" Class="boldtext">Сколько нужно сообществ?</FieldLabel>
                            <FieldBody ColumnSize="ColumnSize.Is5">
                                <NumericEdit Min="1" Max="1000" Step="1" TValue="int?" @bind-Value="@_editTaskModal.CommunitiesResultTaIntersectionCommunitiesCount">
                                    <Feedback>
                                        <ValidationError Tooltip="false" />
                                    </Feedback>
                                </NumericEdit>
                            </FieldBody>
                        </Field>
                    </Validation>
                }

                @if (_editTaskModal.CommunitiesResultCommSearchTypeVisible)
                {
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters mb-0">
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is6">
                                <FieldLabel Class="boldtext">Тип сообществ</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is6">
                                    <Select TValue="VkParsingTaskCommunitySearchCommType" @bind-SelectedValue="@_editTaskModal.CommunitiesResultCommSearchGroupType">
                                        <SelectItem Value="VkParsingTaskCommunitySearchCommType.Unknown"><Text></Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchCommType.Group"><Text>Группы</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchCommType.Page"><Text>Паблики</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchCommType.Event"><Text>Мероприятия</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchCommType.FutureEvent"><Text>Предстоящие мероприятия</Text></SelectItem>
                                    </Select>
                                </FieldBody>
                            </Field>
                            @*<Field ColumnSize="ColumnSize.Is6">
                                <FieldLabel Class="boldtext">Сортировка</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is6">
                                    <Select TValue="VkParsingTaskCommunitySearchResultSort" @bind-SelectedValue="@_editTaskModal.CommunitiesResultCommSearchResultSort">
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.Unknown"><Text></Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.Default"><Text>По-умолчанию</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.GrowthSpeed"><Text>По скорости роста</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.DailyVisitors"><Text>По дневной посещаемости</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.LikesCount"><Text>По количеству лайков</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.CommentsCount"><Text>По количеству комментариев</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchResultSort.DiscussionsCount"><Text>По количеству записей в обсуждениях</Text></SelectItem>
                                    </Select>
                                </FieldBody>
                            </Field>*@
                        </Fields>
                    </Field>
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters mb-0">
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is6">
                                <FieldLabel Class="boldtext">Участников от</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is6">
                                    <NumericEdit TValue="int?" @bind-Value="@_editTaskModal.CommunitiesResultCommSearchMembersMin" />
                                </FieldBody>
                            </Field>
                            <Field ColumnSize="ColumnSize.Is6">
                                <FieldLabel Class="boldtext">Участников до</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is6">
                                    <NumericEdit TValue="int?" @bind-Value="@_editTaskModal.CommunitiesResultCommSearchMembersMax" />
                                </FieldBody>
                            </Field>
                        </Fields>
                    </Field>
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters mb-0">
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is6">
                                <Check TValue="bool" @bind-Checked="_editTaskModal.CommunitiesResultCommSearchPhraseSearch">Точное вхождение поисковой фразы</Check>
                            </Field>
                            <Field ColumnSize="ColumnSize.Is6">
                                <Check TValue="bool" @bind-Checked="_editTaskModal.CommunitiesResultCommSearchVerified">Только верифицированные сообщества</Check>
                            </Field>
                        </Fields>
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is6">
                                <Check TValue="bool" @bind-Checked="_editTaskModal.CommunitiesResultCommSearchTrending">Только сообщества c Прометеем</Check>
                            </Field>
                            <Field ColumnSize="ColumnSize.Is6">
                                <Check TValue="bool" @bind-Checked="_editTaskModal.CommunitiesResultCommSearchMarketOnly">Только сообщества с товарами</Check>
                            </Field>
                        </Fields>
                    </Field>
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters mb-0">
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is12">
                                <FieldLabel Class="boldtext">Каких ключевых слов не должно быть</FieldLabel>
                                <MemoEdit @bind-Text="@_editTaskModal.CommunitiesResultCommSearchMinusWords" Rows="2" MaxLength="6000"
                                          Autofocus="false" Placeholder="Введите минус-слова через запятую (например: продаю,дёшево)" />
                            </Field>
                        </Fields>
                    </Field>
                    <Field ColumnSize="ColumnSize.Is12" Class="no-gutters mb-0">
                        <Fields>
                            <Field ColumnSize="ColumnSize.Is12">
                                <FieldLabel Class="boldtext">Где искать?</FieldLabel>
                                <FieldBody ColumnSize="ColumnSize.Is12">
                                    <Select TValue="VkParsingTaskCommunitySearchSearchType" @bind-SelectedValue="@_editTaskModal.CommunitiesResultCommSearchSearchType">
                                        <SelectItem Value="VkParsingTaskCommunitySearchSearchType.Internal"><Text>В Venando</Text></SelectItem>
                                        <SelectItem Value="VkParsingTaskCommunitySearchSearchType.Vkontakte"><Text>Во ВКонтакте</Text></SelectItem>
                                    </Select>
                                </FieldBody>
                            </Field>
                        </Fields>
                    </Field>
                }

                @if (_editTaskModal.FilterSectionVisible)
                {
                    <Divider Style="margin-top:1.5rem" DividerType="DividerType.TextContent" Text="Фильтрация" />

                    <Field ColumnSize="ColumnSize.Is12" Class="boldtext">
                        <Switch TValue="bool"
                                Checked="_editTaskModal.FilterEnabled"
                                Color="Color.Primary"
                                CheckedChanged="@OnFilterEnabledChanged">
                            <Text>Фильтровать результаты</Text>
                        </Switch>
                    </Field>

                    @if (_editTaskModal.CommunityFilterOptionsVisible)
                    {
                        <Field Horizontal="true" ColumnSize="ColumnSize.Is12" Class="no-gutters" Style="margin-bottom:0rem">
                            <FieldLabel ColumnSize="ColumnSize.Is4">Дата последнего поста</FieldLabel>
                            <FieldBody ColumnSize="ColumnSize.Is8">
                                <Fields>
                                    <Validation Validator="@ValidateCommunityWallPostPeriodStart">
                                        <Field ColumnSize="ColumnSize.Is5">
                                            <Addons>
                                                <Addon AddonType="AddonType.Start">
                                                    <AddonLabel>c</AddonLabel>
                                                </Addon>
                                                <Addon AddonType="AddonType.Body">
                                                    @*https://github.com/stsrki/Blazorise/issues/1811*@
                                                    @*https://github.com/stsrki/Blazorise/issues/1812*@
                                                    <DateEdit TValue="DateTime?" Date="@_commLastWallPostPeriodStart" DateChanged="@OnLastCommWallPostPeriodStartChanged" />
                                                </Addon>
                                            </Addons>
                                        </Field>
                                    </Validation>
                                    <Validation Validator="@ValidateCommunityWallPostPeriodEnd">
                                        <Field ColumnSize="ColumnSize.Is5">
                                            <Addons>
                                                <Addon AddonType="AddonType.Start">
                                                    <AddonLabel>по</AddonLabel>
                                                </Addon>
                                                <Addon AddonType="AddonType.Body">
                                                    @*https://github.com/stsrki/Blazorise/issues/1811*@
                                                    @*https://github.com/stsrki/Blazorise/issues/1812*@
                                                    <DateEdit TValue="DateTime?" Date="@_commLastWallPostPeriodEnd" DateChanged="@OnLastCommWallPostPeriodEndChanged" />
                                                </Addon>
                                            </Addons>
                                        </Field>
                                    </Validation>
                                    <Field ColumnSize="ColumnSize.Is12">
                                        <Icon Name="IconName.ExclamationCircle" Style="color:#ffa200" /> Фильтрация по постам сильно замедляет выполнение задачи и на неё существует суточный лимит
                                    </Field>
                                </Fields>
                            </FieldBody>
                        </Field>
                    }
                }

                @if (_editTaskModal.AutomationSectionVisible)
                {
                    <Divider Style="margin-top:1.5rem" DividerType="DividerType.TextContent" Text="Автоматизация" />

                    <Field ColumnSize="ColumnSize.Is12" Class="boldtext">
                        <Switch TValue="bool"
                                Disabled="true"
                                @bind-Checked="_editTaskModal.CreatePeriodicTask"
                                Color="Color.Primary">
                            <Text>Создать после выполнения периодическое задание</Text>
                        </Switch>
                    </Field>

                    @if (_editTaskModal.PeriodicTaskOptionsVisible)
                    {
                        <Field ColumnSize="ColumnSize.Is12" Horizontal="true" Class="no-gutters">
                            <FieldLabel ColumnSize="ColumnSize.Is4">Периодичность запуска задачи</FieldLabel>
                            <FieldBody ColumnSize="ColumnSize.Is8">
                                <Select TValue="VkPeriodicParsingTaskRate?" @bind-SelectedValue="@_editTaskModal.PeriodicTaskExecutionRate">
                                    <SelectItem Value="VkPeriodicParsingTaskRate.HalfHour"><Text>@VkPeriodicParsingTaskRate.HalfHour.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.Hour"><Text>@VkPeriodicParsingTaskRate.Hour.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.TwoHours"><Text>@VkPeriodicParsingTaskRate.TwoHours.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.ThreeHours"><Text>@VkPeriodicParsingTaskRate.ThreeHours.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.SixHours"><Text>@VkPeriodicParsingTaskRate.SixHours.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.TwelveHours"><Text>@VkPeriodicParsingTaskRate.TwelveHours.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.TwentyFourHours"><Text>@VkPeriodicParsingTaskRate.TwentyFourHours.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.FortyEightHours"><Text>@VkPeriodicParsingTaskRate.FortyEightHours.GetUiName()</Text></SelectItem>
                                    <SelectItem Value="VkPeriodicParsingTaskRate.Nightly"><Text>@VkPeriodicParsingTaskRate.Nightly.GetUiName()</Text></SelectItem>
                                </Select>
                            </FieldBody>
                        </Field>
                    }
                }

                @if (_editTaskModal.VkAdsExportSectionVisible)
                {
                    @if (_editTaskModal.ResultType == VkParsingTaskResultType.Profiles)
                    {
                        <Divider Style="margin-top:1.5rem" DividerType="DividerType.TextContent" Text="Экспорт в рекламный кабинет" />

                        <Field ColumnSize="ColumnSize.Is12" Class="boldtext">
                            <Switch TValue="bool"
                                    @bind-Checked="_editTaskModal.ExportToVkAds"
                                    Color="Color.Primary">
                                <Text>Выгрузить результат в рекламный кабинет ВКонтакте</Text>
                            </Switch>
                        </Field>

                        @if (_editTaskModal.VkAdsAccountSelectorVisible)
                        {
                            <Validation Validator="@ValidateVkAdsAccountOption">
                                <Field ColumnSize="ColumnSize.Is12" Horizontal="true" Class="no-gutters" Style="margin-bottom:0.5rem">
                                    <FieldLabel ColumnSize="ColumnSize.Is6">Рекламный кабинет</FieldLabel>
                                    <FieldBody ColumnSize="ColumnSize.Is6">
                                        <Select TValue="long"
                                                SelectedValue="@_editTaskModal.VkAdsAccountId"
                                                SelectedValueChanged="@_editTaskModal.OnVkAdsAccountChangedAsync"
                                                Disabled="@(_editTaskModal.AvailableVkAdsAccounts == null)">
                                            @if (_editTaskModal.AvailableVkAdsAccounts == null)
                                            {
                                                @if (_editTaskModal.VkAdsAccount == null)
                                                {
                                                    <SelectItem TValue="long" Value="0"><Text>загрузка...</Text></SelectItem>
                                                }
                                                else
                                                {
                                                    <SelectItem TValue="long" Value="@_editTaskModal.VkAdsAccount.Id"><Text>@_editTaskModal.VkAdsAccount.Name</Text></SelectItem>
                                                }
                                            }
                                            else
                                            {
                                                <SelectItem Value="0"><Text></Text></SelectItem>
                                                @foreach (VkAdsAccountVm account in _editTaskModal.AvailableVkAdsAccounts)
                                                {
                                                    <SelectItem Value="@account.Id"><Text>@account.Name</Text></SelectItem>
                                                }
                                            }
                                        </Select>
                                    </FieldBody>
                                </Field>
                            </Validation>

                            @if (_editTaskModal.VkAdsTargetGroupsSelectorVisible)
                            {
                                <Validation Validator="@ValidateVkAdsTargetGroupOption">
                                    <Field ColumnSize="ColumnSize.Is12" Horizontal="true" Class="no-gutters" Style="margin-bottom:0.5rem">
                                        <FieldLabel ColumnSize="ColumnSize.Is6">Группа аудитории</FieldLabel>
                                        <FieldBody ColumnSize="ColumnSize.Is6">
                                            <Select TValue="long"
                                                    SelectedValue="@_editTaskModal.VkAdsTargetGroupId"
                                                    SelectedValueChanged="@_editTaskModal.OnVkAdsTargetGroupChanged"
                                                    Disabled="@(_editTaskModal.AvailableVkAdsTargetGroups == null)">
                                                @if (_editTaskModal.AvailableVkAdsTargetGroups == null)
                                                {
                                                    @if (_editTaskModal.VkAdsTargetGroup == null)
                                                    {
                                                        <SelectItem TValue="long" Value="0"><Text>загрузка...</Text></SelectItem>
                                                    }
                                                    else
                                                    {
                                                        <SelectItem TValue="long" Value="@_editTaskModal.VkAdsTargetGroup.Id"><Text>@_editTaskModal.VkAdsTargetGroup.Name</Text></SelectItem>
                                                    }
                                                }
                                                else
                                                {
                                                    <SelectItem TValue="long" Value="0"><Text></Text></SelectItem>
                                                    @foreach (VkAdsTargetGroupVm targetGroup in _editTaskModal.AvailableVkAdsTargetGroups)
                                                    {
                                                        <SelectItem TValue="long" Value="@targetGroup.Id"><Text>@targetGroup.Name</Text></SelectItem>
                                                    }
                                                }
                                            </Select>
                                        </FieldBody>
                                    </Field>
                                </Validation>
                            }
                            @if (_editTaskModal.NewTargetGroupNameSelectorVisible)
                            {
                                <Validation>
                                    <Field ColumnSize="ColumnSize.Is12" Horizontal="true" Class="no-gutters" Style="margin-bottom:0.5rem">
                                        <FieldLabel ColumnSize="ColumnSize.Is6">Имя новой группы аудитории</FieldLabel>
                                        <FieldBody ColumnSize="ColumnSize.Is6">
                                            <TextEdit Display="Display.InlineBlock" @bind-Text="@_editTaskModal.NewTargetGroupName">
                                                <Feedback>
                                                    <ValidationError Tooltip="false" />
                                                </Feedback>
                                            </TextEdit>
                                        </FieldBody>
                                    </Field>
                                </Validation>
                            }
                        }
                    }
                }
            </Validations>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="OnModalClose">Закрыть</Button>
            <Button Loading="@_submitButtonIsLoading" Disabled="@_editTaskModal.SubmitButtonDisabled" Color="Color.Primary" Clicked="@OnSaveVkParsingTask"> Сохранить изменения</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code
{
    [Parameter]
    public EventCallback<string> OnTaskSavedCallback { get; set; }

    private Modal _modal;
    private VkPeriodicParsingTaskModal _editTaskModal;

    private string _selectedSearchValue { get; set; }

    private Validations _editParsingTaskModalValidation;

    private bool _submitButtonIsLoading = false;
    private bool _tasksSourcesIsLoading = false;

    private VkPeriodicParsingTaskSm _sourceModel;

    //элемент поля Удалить не работает, если опираемся на свойство компонента Date, поэтому дублируем
    private DateTime? _activePeriodStart;
    private DateTime? _activePeriodEnd;

    private DateTime? _commLastWallPostPeriodStart;
    private DateTime? _commLastWallPostPeriodEnd;

    private bool _canBeClosed;

    private EventHandler _modalPropertyChanged;
    private EventHandler<ExportToVkAdsChangedEventArgs> _exportToVkChanged;



    protected override void OnInitialized()
    {
        _editTaskModal = EditTaskModal;

        _modalPropertyChanged = async (s, args) => await HandleModalChangedTimerCallback();
        _editTaskModal.PropertyChanged += _modalPropertyChanged;

        _exportToVkChanged = async (s, args) => await OnExportToVkAdsChangedAsync(args);
        _editTaskModal.ExportToVkAdsChanged += _exportToVkChanged;

        base.OnInitialized();
    }

    public async Task ShowWithModel(VkPeriodicParsingTaskVm parsingTaskVm)
    {
        _sourceModel = Mapper.Map<VkPeriodicParsingTaskSm>(parsingTaskVm);

        _editTaskModal.LoadModel(parsingTaskVm);

        _activePeriodStart = _editTaskModal.ProfilesResultActivePeriodStart;
        _activePeriodEnd = _editTaskModal.ProfilesResultActivePeriodEnd;
        _commLastWallPostPeriodStart = _editTaskModal.LastCommWallPostPeriodStart;
        _commLastWallPostPeriodEnd = _editTaskModal.LastCommWallPostPeriodEnd;

        _editTaskModal.OptionsEnabled = true;

        _editTaskModal.SetTaskOptionsAvailabilityBasedOnLoadedModelForEdit();

        _editTaskModal.UpdateOptionsVisibility();
        _editTaskModal.UpdateTooltipTexts();

        _editParsingTaskModalValidation.ClearAll();

        _modalAlert.Hide();

        _modal.Show();

        Task getCurrentTasks = GetAvailableTasksListAsync(parsingTaskVm);
        Task getCurrentAds = _editTaskModal.GetAvailableVkAdsParams();
        await Task.WhenAll(getCurrentTasks, getCurrentAds);
        StateHasChanged(); //надо ли?
    }

    public void ResetModalCheckingTimer()
    {
        //используем в куче с другими запросами, благодаря задержке размазываем нагрузку на сервер
        _editTaskModal.ResetCheckingTimer(200);
    }

    private void OnModalClosing(CancelEventArgs e)
    {
        // just set Cancel to true to prevent modal from closing
        if (_canBeClosed)
        {
            _modalAlert.Hide();

            _editTaskModal.Reset();
            ResetModalHelpingData();
        }
        else
        {
            e.Cancel = true;
        }
    }

    private void OnModalClose()
    {
        _canBeClosed = true;
        _modal.Hide();
        _canBeClosed = false;
    }

    private void ResetModalHelpingData()
    {
        _commLastWallPostPeriodStart = null;
        _commLastWallPostPeriodEnd = null;

        ResetTaskSourceTabsHelpingData();
    }

    private void ValidateSourceIdsRawInput(ValidatorEventArgs e)
    {
        string rawInput = Convert.ToString(e.Value);

        if (string.IsNullOrEmpty(rawInput))
        {
            e.Status = ValidationStatus.None;
        }
        else if (string.IsNullOrWhiteSpace(rawInput))
        {
            e.Status = ValidationStatus.Error;

            switch (_editTaskModal.OptionsSmSourceObjectsType)
            {
                case VkParsingTaskSourcesObjectType.Group:
                    e.ErrorText = "Введите группы";
                    break;
                case VkParsingTaskSourcesObjectType.User:
                    e.ErrorText = "Введите профили";
                    break;
                case VkParsingTaskSourcesObjectType.Keyword:
                    e.ErrorText = "Введите ключевые слова";
                    break;
                default:
                case VkParsingTaskSourcesObjectType.Unknown:
                    e.ErrorText = "Введите источники";
                    break;
            }
        }
        else
        {
            bool valid = true;

            if (_editTaskModal.SourcesCountInvalid)
            {
                valid = false;
                e.ErrorText = "Введите не более 1000 групп, профилей или ключевых фраз";
            }
            else if (_editTaskModal.ValidatedForm.SourcesObjectType == VkParsingTaskSourcesObjectType.Unknown)
            {
                valid = false;
                e.ErrorText = "Введите группы, профили или ключевые слова";
            }
            else if (_editTaskModal.ValidatedForm.SourcesObjectType != _editTaskModal.OptionsSmSourceObjectsType)
            {
                valid = false;

                string linkSourceType = string.Empty;

                VkParsingTaskSourcesObjectType currentType = _editTaskModal.OptionsSmSourceObjectsType;

                switch (currentType)
                {
                    case VkParsingTaskSourcesObjectType.Group:
                        linkSourceType = "сообщество";
                        break;
                    case VkParsingTaskSourcesObjectType.User:
                        linkSourceType = "пользователя";
                        break;
                    case VkParsingTaskSourcesObjectType.Keyword:
                        linkSourceType = "ключевое слово";
                        break;
                    default:
                    case VkParsingTaskSourcesObjectType.Unknown:
                        break;
                }

                e.ErrorText = "В задаче нельзя изменить тип входных данных: введите " + linkSourceType;
            }

            e.Status = valid ? ValidationStatus.Success : ValidationStatus.Error;
        }
    }

    private void ValidateActivityPerodStart(ValidatorEventArgs e)
    {
        DateTime rawPeriodStart = Convert.ToDateTime(e.Value);

        e.Status = rawPeriodStart > DateTime.MinValue ? ValidationStatus.Success : ValidationStatus.Error;
    }

    private void ValidateActivityPerodEnd(ValidatorEventArgs e)
    {
        DateTime rawPeriodEnd = Convert.ToDateTime(e.Value);

        e.Status = rawPeriodEnd > DateTime.MinValue ? ValidationStatus.Success : ValidationStatus.Error;
    }

    private void ValidateVkAdsAccountOption(ValidatorEventArgs e)
    {
        long value = Convert.ToInt64(e.Value);

        if (_editTaskModal.ExportToVkAds)
        {
            e.Status = (value != 0) ? ValidationStatus.Success : ValidationStatus.Error;
        }
        else
        {
            e.Status = ValidationStatus.None;
        }
    }

    private void ValidateVkAdsTargetGroupOption(ValidatorEventArgs e)
    {
        long value = Convert.ToInt64(e.Value);

        if (_editTaskModal.ExportToVkAds && _editTaskModal.VkAdsAccountId != 0)
        {
            e.Status = (value != 0) ? ValidationStatus.Success : ValidationStatus.Error;
        }
        else
        {
            e.Status = ValidationStatus.None;
        }
    }

    private void ValidateCommunityWallPostPeriodStart(ValidatorEventArgs e)
    {
        //браузер допускает года вроде 20060, но конвертация забирает только 4 цифры, поэтому возможны эффекты
        //https://github.com/stsrki/Blazorise/issues/1812
        DateTime rawPeriodStart = Convert.ToDateTime(e.Value);

        e.Status = rawPeriodStart > DateTime.MinValue ? ValidationStatus.Success : ValidationStatus.Error;
    }

    private void ValidateCommunityWallPostPeriodEnd(ValidatorEventArgs e)
    {
        //браузер допускает года вроде 20060, но конвертация забирает только 4 цифры, поэтому возможны эффекты
        //https://github.com/stsrki/Blazorise/issues/1812
        DateTime rawPeriodEnd = Convert.ToDateTime(e.Value);

        e.Status = rawPeriodEnd > DateTime.MinValue ? ValidationStatus.Success : ValidationStatus.Error;
    }

    private async Task OnExportToVkAdsChangedAsync(ExportToVkAdsChangedEventArgs args)
    {
        await _editTaskModal.OnVkAdsExportChangedAsync(args.Value);

        StateHasChanged();
    }


    //технические поля для даты активностей нужно обновлять, иначе пользователю видно минимальное значение
    //если решить проблему, то методы диалога можно обратно прятать
    private void OnProfilesResultSubTypeChanged(VkParsingTaskResultProfilesSubType newValue)
    {
        _editTaskModal.ProfilesResultSubType = newValue;
        _editTaskModal.UpdateOptionValuesOnProfilesResultSubTypeChange(newValue);

        if (newValue == VkParsingTaskResultProfilesSubType.Active)
        {
            _activePeriodStart = DateTime.Now.AddMonths(-1);
            _activePeriodEnd = DateTime.Now;
        }

        _editTaskModal.UpdateOptionsVisibilityAndResetTimer();
    }

    private void OnFilterEnabledChanged(bool value)
    {
        _editTaskModal.FilterEnabled = value;

        if (_commLastWallPostPeriodStart == null || _commLastWallPostPeriodStart == DateTime.MinValue)
        {
            _commLastWallPostPeriodStart = DateTime.Now.AddMonths(-1);
        }

        if (_commLastWallPostPeriodEnd == null || _commLastWallPostPeriodEnd == DateTime.MinValue)
        {
            _commLastWallPostPeriodEnd = DateTime.Now;
        }

        StateHasChanged();
    }

    private async Task HandleModalChangedTimerCallback()
    {
        _submitButtonIsLoading = true;
        StateHasChanged();

        // валидаторы блейзорайс не учитывают все настройки, надо объединять с кастомными
        bool sourcesValid = _editTaskModal.ValidateSources();

        if (sourcesValid)
        {
            bool remoteValid = await _editTaskModal.ValidateRemotelyAsync();

            if (remoteValid)
            {
                _editTaskModal.UpdateOptionsVisibility();

                bool customValid = _editTaskModal.ValidateUpdatedModalOptions();
                //после удаления и возвращения видимости полей возвращается ДА не вызывая никаких проверок
                //https://github.com/a-postx/YA.WebClient/issues/2
                bool blazoriseValid = _editParsingTaskModalValidation.ValidateAll();

                if (customValid && blazoriseValid)
                {
                    _editTaskModal.SubmitButtonDisabled = false;
                }
            }
            else
            {
                _editParsingTaskModalValidation.ValidateAll();
            }
        }
        else
        {
            _editParsingTaskModalValidation.ValidateAll();
        }

        _submitButtonIsLoading = false;
        StateHasChanged();
    }

    private void OnActivePeriodStartChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _activePeriodStart = date;
            _editTaskModal.ProfilesResultActivePeriodStart = date;
        }
        else //если не прописывать этот вариант, то получаем неработающий сброс в поле компонента
        {
            _activePeriodStart = null;
        }
    }

    private void OnActivePeriodEndChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _activePeriodEnd = date;
            _editTaskModal.ProfilesResultActivePeriodEnd = date;
        }
        else //если не прописывать этот вариант, то получаем неработающий сброс в поле компонента
        {
            _activePeriodEnd = null;
        }
    }

    private void OnLastCommWallPostPeriodStartChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _commLastWallPostPeriodStart = date;
            _editTaskModal.LastCommWallPostPeriodStart = date;
        }
        else //если не прописывать этот вариант, то получаем неработающий сброс в поле компонента
        {
            _commLastWallPostPeriodStart = null;
            _editTaskModal.LastCommWallPostPeriodStart = null;
        }
    }

    private void OnLastCommWallPostPeriodEndChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            _commLastWallPostPeriodEnd = date;
            _editTaskModal.LastCommWallPostPeriodEnd = date;
        }
        else //если не прописывать этот вариант, то получаем неработающий сброс в поле компонента
        {
            _commLastWallPostPeriodEnd = null;
            _editTaskModal.LastCommWallPostPeriodEnd = null;
        }
    }

    private void ResetTaskSourceTabsHelpingData()
    {
        _availableTasks = new List<VkQuickParsingTaskVm>();
        _selectedTasks = new List<VkQuickParsingTaskVm>();
        _selectedSearchValue = null;
    }

    private void OnTaskSearchValueChanged(string newValue)
    {
        VkQuickParsingTaskVm selectedTask = _availableTasks.Where(e => e.Title == newValue).FirstOrDefault();

        if (selectedTask is not null)
        {
            _selectedTasks.Add(selectedTask);

            _editTaskModal.AddTasksAsSources(_selectedTasks, false);
        }
    }

    private void OnTaskItemRemoved(VkQuickParsingTaskVm taskItem)
    {
        _selectedTasks.Remove(taskItem);

        _editTaskModal.AddTasksAsSources(_selectedTasks, false);
    }

    public async Task GetAvailableTasksListAsync(VkPeriodicParsingTaskVm vkPeriodicParsingTaskVm)
    {
        if (vkPeriodicParsingTaskVm?.SourceType == VkParsingTaskSourceType.Tasks)
        {
            _tasksSourcesIsLoading = true;
            StateHasChanged();

            List<string> selectedTaskIds = vkPeriodicParsingTaskVm.Options.RawTaskSources
                .Split(Environment.NewLine).ToList();

            List<Guid> selectedIds = selectedTaskIds
                .Select(e => Guid.TryParse(e, out Guid taskId) ? taskId : Guid.Empty)
                .Where(e => e != Guid.Empty).ToList();

            ApiCommandResult<ICollection<VkQuickParsingTaskVm>> result =
                await ApiRepository.GetVkOneTimeParsingTasks(selectedIds);

            switch (result.Status)
            {
                case ApiCommandStatus.Ok:
                    _selectedTasks = result.Data;
                    break;

                default:
                    break;
            }

            _tasksSourcesIsLoading = false;
            StateHasChanged();
        }
    }

    private string ConvertParsingTask(VkQuickParsingTaskVm task)
    {
        return task?.Title;
    }

    private async Task OnSaveVkParsingTask()
    {
        _submitButtonIsLoading = true;
        _editTaskModal.SubmitButtonDisabled = true;
        StateHasChanged();

        VkPeriodicParsingTaskSm destinationModel = _editTaskModal.CreateSm();
        JsonPatchDocument<VkPeriodicParsingTaskSm> patch = PatchProducer
                .GetPatchForVkPeriodicParsingTask(_sourceModel, destinationModel);

        ApiCommandResult<VkPeriodicParsingTaskVm> result =
            await ApiRepository.UpdateVkPeriodicParsingTask(_editTaskModal.TaskId, patch);

        _submitButtonIsLoading = false;

        switch (result.Status)
        {
            case ApiCommandStatus.Ok:
                _editTaskModal.Reset();
                _canBeClosed = true;
                _modal.Hide();
                _canBeClosed = false;

                await OnTaskSavedCallback.InvokeAsync(result.Data.Title);
                break;

            default:
                _editTaskModal.SubmitButtonDisabled = false;
                break;
        }

        StateHasChanged();
    }

    public override void Dispose()
    {
        _editTaskModal.PropertyChanged -= _modalPropertyChanged;
        _editTaskModal.ExportToVkAdsChanged -= _exportToVkChanged;

        base.Dispose();
    }
}